{% extends 'Base.html' %}
{% load static %}

{% block content %}
<div class="max-w-2xl mx-auto mt-10 p-6 bg-white rounded-lg shadow-md">
    <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Tu perfil</h2>

    <!-- Foto de perfil -->
    <div class="flex flex-col items-center mb-6">
        {% if perfil.foto %}
            <img src="{{ perfil.foto.url }}" alt="Foto de perfil" class="w-32 h-32 rounded-full object-cover mb-4" id="foto-actual">
        {% else %}
            <img src="{% static 'img/sin-foto-perfil.jpg' %}" alt="Foto de perfil" class="w-32 h-32 rounded-full object-cover mb-4 shadow-md" id="foto-actual">
        {% endif %}

        <div class="flex flex-col sm:flex-row gap-2 w-full justify-center">
            <!-- Formulario para cambiar foto -->
            <form method="POST" enctype="multipart/form-data" id="form-cambiar-foto" class="w-full text-center">
                {% csrf_token %}
                <div id="input-foto" class="hidden mb-2">
                    {{ foto_form.foto.as_widget }}
                </div>
                <button type="button" id="btn-cambiar-foto"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded w-full">
                    Cambiar foto
                </button>
                <button type="submit" name="actualizar_foto"
                        class="mt-2 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded w-full hidden"
                        id="btn-subir-foto">
                    Subir nueva foto
                </button>
            </form>

            <!-- Formulario para eliminar foto -->
            {% if perfil.foto %}
            <form method="POST" class="w-full text-center" id="form-eliminar-foto">
                {% csrf_token %}
                <button type="submit" name="eliminar_foto" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded w-full">
                    Eliminar foto
                </button>
            </form>
            {% endif %}
        </div>
    </div>

    {% if not modo_edicion %}
        <!-- Datos como texto -->
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">Usuario</label>
            <p class="text-gray-800 font-semibold">{{ request.user.username }}</p>
        </div>
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
            <p class="text-gray-800">{{ request.user.email }}</p>
        </div>
        <a href="?editar=1" class="mt-4 inline-block bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded">
            Editar datos
        </a>
    {% else %}
        <!-- Formulario de edición -->
        <form method="POST" enctype="multipart/form-data" class="space-y-4">
            {% csrf_token %}

            <!-- Campo de usuario -->
            <div>
                <label for="{{ user_form.username.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                    {{ user_form.username.label }}
                </label>
                {{ user_form.username }}
                {% if user_form.username.errors %}
                    <p class="text-red-600 text-sm mt-1">{{ user_form.username.errors|striptags }}</p>
                {% endif %}
            </div>

            <!-- Campos de contraseña -->
            <div>
                <label for="{{ password_form.old_password.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                    {{ password_form.old_password.label }}
                </label>
                {{ password_form.old_password }}
                {% if password_form.old_password.errors %}
                    <p class="text-red-600 text-sm mt-1">{{ password_form.old_password.errors|striptags }}</p>
                {% endif %}
            </div>

            <div>
                <label for="{{ password_form.new_password1.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                    {{ password_form.new_password1.label }}
                </label>
                {{ password_form.new_password1 }}
                {% if password_form.new_password1.errors %}
                    <p class="text-red-600 text-sm mt-1">{{ password_form.new_password1.errors|striptags }}</p>
                {% endif %}
            </div>

            <div>
                <label for="{{ password_form.new_password2.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                    {{ password_form.new_password2.label }}
                </label>
                {{ password_form.new_password2 }}
                {% if password_form.new_password2.errors %}
                    <p class="text-red-600 text-sm mt-1">{{ password_form.new_password2.errors|striptags }}</p>
                {% endif %}
            </div>

            <div class="flex flex-col sm:flex-row gap-2 mt-2">
                <button type="submit" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded">
                    Guardar cambios
                </button>
                <a href="{% url 'Perfil' %}" class="w-full sm:w-auto text-center bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded">
                    Cancelar
                </a>
            </div>

        </form>
    {% endif %}

    <!-- Sección para desactivar cuenta -->
    <div class="mt-10 border-t pt-6 text-center">
        <h3 class="text-lg font-semibold text-gray-800 mb-2">Desactivar cuenta</h3>
        <p class="text-sm text-gray-600 mb-4">No vas a poder iniciar sesión hasta que se reactive.</p>

        <button onclick="document.getElementById('modal').classList.remove('hidden')" 
                class="bg-yellow-600 hover:bg-yellow-700 text-white font-semibold py-2 px-4 rounded">
            Desactivar cuenta
        </button>
    </div>
</div>

<!-- Modal de confirmación -->
<div id="modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white p-6 rounded-lg shadow-lg max-w-sm w-full text-center">
        <h2 class="text-lg font-bold text-gray-800 mb-4">¿Estás segura?</h2>
        <p class="text-gray-600 mb-6">Esta acción desactivará tu cuenta.</p>

        <form method="POST" action="{% url 'Perfil' %}">
            {% csrf_token %}
            <button type="submit" name="desactivar_cuenta" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded mr-2">
                Sí, desactivar
            </button>
            <button type="button" onclick="document.getElementById('modal').classList.add('hidden')" 
                    class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded">
                Cancelar
            </button>
        </form>
    </div>
</div>
{% endblock %}