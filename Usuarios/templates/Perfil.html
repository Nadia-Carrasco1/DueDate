{% extends 'Base.html' %}
{% load static %}

{% block content %}
{% if messages %}
  <div class="max-w-5xl mx-auto mt-6">
    {% for message in messages %}
      <div class="mb-4 px-4 py-3 rounded {{ message.tags }} bg-green-100 text-green-800">
        {{ message }}
      </div>
    {% endfor %}
  </div>
{% endif %}

<div class="max-w-4xl mx-auto mt-10 p-8 bg-neutral-900 rounded-lg shadow-md text-white">
    <h2 class="text-3xl font-bold text-indigo-400 mb-6 text-center">Tu perfil</h2>

    <div class="flex flex-col md:flex-row gap-8">
    <!-- Columna izquierda: Datos del perfil -->
        <div class="md:w-2/3 space-y-6 px-4">
        <!-- Usuario -->
        <div class="mb-2">
            <label class="block text-lg font-medium text-gray-300 mt-1">Usuario:</label>
            <div id="username-display" class="{% if campo_con_error == 'username' %}hidden{% endif %} flex items-center justify-between">
                <p class="font-semibold">{{ request.user.username }}</p>
                <button onclick="toggleEdit('username')" class="p-2 bg-gray-700 hover:bg-gray-800 rounded text-white">✎</button>
            </div>

            <form method="POST" {% if campo_con_error == 'username' %} {% else %}class="hidden"{% endif %} id="username-form">
                {% csrf_token %}
                <input type="hidden" name="editar_usuario" value="1">
                {{ user_form.username }}
                {% if user_form.username.errors %}
                    <p class="text-red-400 text-sm mt-1">{{ user_form.username.errors|striptags }}</p>
                {% endif %}
                <div class="flex gap-2 mt-2">
                    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-1 px-3 rounded">Guardar</button>
                    <button type="button" onclick="cancelEdit('username')" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-1 px-3 rounded">Cancelar</button>
                </div>
            </form>
        </div>

        <!-- Contraseña -->
        <div class="mb-2">
            <label class="block text-lg font-medium text-gray-300 mt-1">Contraseña:</label>
            <div id="password-display" class="{% if campo_con_error == 'password' %}hidden{% endif %} flex items-center justify-between">
                <p>••••••••</p>
                <button onclick="toggleEdit('password')" class="p-2 bg-gray-700 hover:bg-gray-800 rounded text-white">✎</button>
            </div>

            <form method="POST" {% if campo_con_error == 'password' %} {% else %}class="hidden"{% endif %} id="password-form" class="space-y-4">
                {% csrf_token %}
                <input type="hidden" name="editar_contraseña" value="1">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Contraseña actual:</label>
                    {{ password_form.old_password }}
                    {% if password_form.old_password.errors %}
                    <p class="text-red-400 text-sm mt-1">{{ password_form.old_password.errors|striptags }}</p>
                    {% endif %}
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Contraseña nueva:</label>
                    {{ password_form.new_password1 }}
                    {% if password_form.new_password1.errors %}
                    <p class="text-red-400 text-sm mt-1">{{ password_form.new_password1.errors|striptags }}</p>
                    {% endif %}
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Confirmación:</label>
                    {{ password_form.new_password2 }}
                    {% if password_form.new_password2.errors %}
                    <p class="text-red-400 text-sm mt-1">{{ password_form.new_password2.errors|striptags }}</p>
                    {% endif %}
                </div>
                <div class="flex gap-2 mt-2">
                    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-1 px-3 rounded">Guardar</button>
                    <button type="button" onclick="cancelEdit('password')" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-1 px-3 rounded">Cancelar</button>
                </div>
            </form>
        </div>

        <!-- Email -->
        <div class="mb-2">
            <label class="block text-lg font-medium text-gray-300 mb-1">Email:</label>
            <p>{{ request.user.email }}</p>
        </div>

        <!-- Fecha de nacimiento -->
        <div class="mb-2">
            <label class="block text-lg font-medium text-gray-300 mb-1">Fecha de nacimiento:</label>
            <p>{{ perfil.fecha_nacimiento|date:"d/m/Y" }}</p>
            <p class="text-sm text-gray-400">Edad: {{ perfil.fecha_nacimiento|timesince }}</p>
        </div>

        <!-- Eliminar cuenta -->
        <div class="border-t pt-6 text-center mb-4">
            <h3 class="text-lg font-semibold text-red-400 mb-2">Eliminar cuenta</h3>
            <button type="button" onclick="mostrarModal()" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded">
            Confirmar
            </button>
        </div>
    </div>

   <!-- Columna derecha: Foto y edición -->
    <div class="md:w-1/3 flex flex-col px-4">
        <div class="flex justify-center mb-4">
            <div class="w-48 flex flex-col items-end ">
                {% if perfil.foto %}
                <img src="{{ perfil.foto.url }}" alt="Foto de perfil" class="w-48 h-48 rounded-full object-cover shadow-md mb-2">
                {% else %}
                <img src="{% static 'img/sin-foto-perfil.jpg' %}" alt="Foto de perfil" class="w-48 h-48 rounded-full object-cover shadow-md mb-2">
                {% endif %}
                <button type="button" onclick="toggleFotoEdicion()" class="p-2 bg-gray-700 hover:bg-gray-800 rounded text-white">
                ✎
                </button>
            </div>
        </div>

    <!-- Contenedor de edición de foto -->
        <div id="foto-edicion" class="w-full text-center hidden">
            <form method="POST" enctype="multipart/form-data" id="form-cambiar-foto">
                {% csrf_token %}
                <div id="input-foto" class="hidden mb-2">
                    {{ foto_form.foto.as_widget }}
                </div>
                <button type="button" id="btn-cambiar-foto" class="bg-indigo-800 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded w-full mb-2">
                    Cambiar foto
                </button>
                <button type="submit" name="actualizar_foto" id="btn-subir-foto" class="bg-green-600 disabled:opacity-50 disabled:cursor-not-allowed disabled:pointer-events-none hover:bg-green-700 text-white font-semibold py-2 px-4 rounded w-full hidden" disabled>
                    Subir nueva foto
                </button>
                <button type="button" id="btn-cancelar-foto" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded w-full hidden mb-2">
                    Cancelar
                </button>
            </form>

            {% if perfil.foto %}
            <form method="POST" class="w-full text-center" id="form-eliminar-foto">
                {% csrf_token %}
                <button type="submit" name="eliminar_foto" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded w-full">
                    Eliminar foto
                </button>
            </form>
            {% endif %}
        </div>
    </div>

</div>

<!-- Modal de confirmación -->
<div id="modal-eliminar" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-neutral-800 rounded-lg shadow-xl p-6 max-w-sm w-full text-center">
    <h4 class="text-xl font-bold text-white mb-4">¿Quieres realizar esta acción?</h4>
    <p class="text-white mb-6">Eliminarás tu cuenta</p>
    <div class="flex justify-center gap-4">
      <button onclick="cerrarModal()" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded">
        Cancelar
      </button>
      <form method="POST">
        {% csrf_token %}
        <input type="hidden" name="desactivar_cuenta" value="1">
        <button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded">
          Sí, eliminar
        </button>
      </form>
    </div>
  </div>
</div>


<script>
function toggleEdit(field) {
    const secciones = ['username', 'password'];  
    secciones.forEach(f => {
        const display = document.getElementById(`${f}-display`);
        const form = document.getElementById(`${f}-form`);

        if (f === field) {
            display.classList.toggle('hidden');
            form.classList.toggle('hidden');
        } else {
            if (display && form) {
                display.classList.remove('hidden');
                form.classList.add('hidden');
            }
        }
    });
}
function mostrarModal() {
    document.getElementById("modal-eliminar").classList.remove("hidden");
}

function cerrarModal() {
    document.getElementById("modal-eliminar").classList.add("hidden");
}

function toggleFotoEdicion() {
  const contenedor = document.getElementById("foto-edicion");
  contenedor.classList.toggle("hidden");
}
setTimeout(() => {
    document.querySelectorAll('.bg-green-100, .bg-red-100, .bg-yellow-100').forEach(el => {
      el.classList.add('hidden');
    });
}, 5000);
function cancelEdit(field) {
    // Oculta el formulario y muestra la vista normal
    toggleEdit(field);

    // Elimina mensajes de error
    document.querySelectorAll(`#${field}-form .text-red-400`).forEach(el => el.remove());

    // Obtén el formulario
    const form = document.getElementById(`${field}-form`);
    if (!form) return;

    // Casos especiales según el campo
    if (field === 'password') {
        // Limpia los inputs de contraseña
        form.reset();
    } 
    else if (field === 'username') {
        // Restaura el valor original del nombre de usuario
        const originalUsername = document.querySelector('#username-display p')?.innerText.trim();
        const usernameInput = form.querySelector('input[name="username"]');
        if (originalUsername && usernameInput) {
            usernameInput.value = originalUsername;
        }
    }
}
</script>
{% endblock %}