{% extends 'Base.html' %}
{% load static %}

{% block tittle %}Calendario{% endblock %}

{% block content %}

{% if messages %}
  <div id="djangoMessages" class="max-w-4xl mx-auto mb-4">
    {% for message in messages %}
      <div class="mensaje-django p-3 rounded text-white shadow transition-opacity duration-500
                  {% if message.tags == 'success' %}bg-green-600
                  {% elif message.tags == 'error' %}bg-red-600
                  {% elif message.tags == 'info' %}bg-blue-600
                  {% else %}bg-gray-600{% endif %}">
        {{ message }}
      </div>
    {% endfor %}
  </div>
{% endif %}

<div id="mensaje-exportacion" class="hidden max-w-4xl mx-auto mb-4">
  <div class="bg-yellow-600 text-white p-3 rounded shadow" id="texto-mensaje-exportacion">
  </div>
</div>

<div class="container mx-auto p-4">
  <div id="calendar" class="bg-purple-100 text-purple-900 p-4 rounded shadow max-w-4xl h-[80vh] overflow-auto mx-auto"></div>
</div>
<div id="dropdown-export" class="absolute hidden w-40 p-2 text-sm bg-neutral-700 rounded-md shadow-lg z-50 font-normal text-white/75">
  <ul class="flex flex-col">
    <button onclick="exportEvents('week')" class="py-1 px-2 text-left hover:bg-neutral-600">
      <li>Semana</li>
    </button>
    <hr class="border-neutral-600 my-1">
    <button onclick="exportEvents('month')" class="py-1 px-2 text-left hover:bg-neutral-600">
      <li>Mes</li>
    </button>
  </ul>
</div>

<!-- MODAL CREAR -->
<div id="modalCrearEvento" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-neutral-900 text-white p-6 rounded w-full max-w-md shadow-lg relative">
    <button id="cerrarModalBtn" class="cerrar-modal absolute top-2 right-2 text-white">&times;</button>
    <h2 class="text-xl font-bold mb-4 text-purple-400">Nuevo Evento</h2>
    <form id="eventoForm" method="POST" action="{% url 'calendario' %}">
      {% csrf_token %}
      {% if form.non_field_errors %}
        <div class="text-red-500 mb-2">
          {{ form.non_field_errors }}
        </div>
      {% endif %}
      {{ form.as_p }}
      <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded mt-2">Guardar</button>
    </form>
  </div>
</div>

<!-- MODAL VER -->
<div id="modalVerEvento" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-neutral-900 text-white p-6 rounded w-full max-w-md shadow-lg relative">
    <button id="cerrarVerModalBtn" class="cerrar-modal absolute top-2 right-2 text-white">&times;</button>
    <h2 class="text-xl font-bold mb-4 text-purple-400">Evento</h2>
    <div id="detalleEvento" class="mb-4">
      <p><strong>Título:</strong> <span id="eventoTitulo"></span></p>
      <p><strong>Inicio:</strong> <span id="eventoInicio"></span></p>
      <p><strong>Fin:</strong> <span id="eventoFin"></span></p>
      <p><strong>Descripción:</strong> <span id="eventoDescripcion"></span></p>
      <p><strong>Recordatorio:</strong> <span id="eventoRecordatorio"> </span><span id="eventoRecordatorioFecha"></span></p>
      <p><strong>Repetición:</strong> <span id="eventoRepeticion"></span></p>
    </div>
    <div class="flex gap-2">
      <button id="abrirEditarModalBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded">Editar</button>
      <form id="formEliminarEvento" method="POST" action="{% url 'eliminar_evento' %}">
        {% csrf_token %}
        <input type="hidden" name="evento_id" id="eventoIdEliminar">
        <button type="submit" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">Eliminar</button>
      </form>
    </div>
  </div>
</div>

<!-- MODAL EDITAR -->
<div id="modalEditarEvento" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-neutral-900 text-white p-6 rounded w-full max-w-md shadow-lg relative">
    <button id="cerrarEditarModalBtn" class="cerrar-modal absolute top-2 right-2 text-white">&times;</button>
    <h2 class="text-xl font-bold mb-4 text-purple-400">Editar Evento</h2>

    <div class="form-wrapper"></div>

    <div id="mensajeErrorEditar" class="hidden text-red-500 text-sm mt-2"></div>
    <div id="mensajeSinCambios" class="hidden text-yellow-400 text-sm mt-2"></div>
  </div>
</div>

<!-- MODAL CONFIRMAR ELIMINAR -->
<div id="modalConfirmarEliminar" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-neutral-900 text-white p-6 rounded w-full max-w-sm shadow-lg text-center">
    <h2 class="text-lg font-bold text-red-400 mb-4">Eliminar evento</h2>
    <p class="mb-4">¿Quieres ejecutar esta acción?</p>
    <div class="flex justify-center gap-4">
      <button id="cancelarEliminarBtn" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded">Cancelar</button>
      <button id="confirmarEliminarBtn" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded">Eliminar</button>
    </div>
  </div>
</div>
{% block extra_scripts %}
  <script src="https://unpkg.com/@popperjs/core@2"></script>
  <script src="https://unpkg.com/tippy.js@6"></script>
  <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/themes/light.css" />

  <script src="https://cdn.jsdelivr.net/npm/rrule@2.6.8/dist/es5/rrule.min.js"></script>
  <script>window.RRule = window.RRule;</script>

  <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.8/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.8/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/timegrid@6.1.8/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/list@6.1.8/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/interaction@6.1.8/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/rrule@6.1.8/index.global.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script type="module" src="/static/js/calendario/main.js"></script>
  <script type="module" src="/static/js/calendario/calendario.js"></script>
  <script type="module" src="/static/js/calendario/edicionEvento.js"></script>
  <script type="module" src="/static/js/calendario/modales.js"></script>
  <script type="module" src="/static/js/calendario/utils.js"></script>
  <script type="module" src="/static/js/calendario/descargarPDF.js"></script>

  {% if form.errors %}
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const modal = document.getElementById('modalCrearEvento');
      if (modal) modal.classList.remove('hidden');
    });
  </script>
  {% endif %}
    

{% endblock %}
{% endblock %}
